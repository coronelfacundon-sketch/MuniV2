<!DOCTYPE html><html lang="es"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Empleados — Panel</title><link rel="stylesheet" href="../assets/styles.css"></head><body>
<div class="wrap"><header class="header"><div class="brand"><div class="logo"></div><div class="title"><h1>Empleados</h1><p>Panel interno — <a href="../index.html">Volver</a></p></div></div><div class="breadcrumbs"><a href="../index.html">Inicio</a> / Empleados</div></header>
<section class="grid"><div class="card"><div class="body"><h2>Ingreso</h2><div class="row cols-3"><div><label>Usuario</label><input id="login-user" placeholder="MUNI"></div><div><label>Clave</label><input id="login-pass" type="password" placeholder="MUNIISAP123"></div><div class="actions" style="align-self:end"><button class="btn primary" id="btn-login">Ingresar</button><span class="helper">Login simulado</span></div></div></div></div>
<div class="card" id="panel-sec" hidden><div class="body">
<div class="row cols-3"><div><label>Filtrar por tipo</label><select id="f-tipo"><option value="">Todos</option><option>PF-MONO</option><option>PF-RI</option></select></div><div><label>Estado</label><select id="f-estado"><option value="">Todos</option><option value="1">Completos</option><option value="0">Incompletos</option></select></div><div><label>Rubro</label><select id="f-rubro"><option value="">Todos</option><option value="ALIMENTOS_GASTRONOMIA">Gastronomía</option><option value="COMERCIO_MINORISTA">Comercio</option><option value="SERVICIOS_PROFESIONALES">Servicios profesionales</option><option value="SERVICIOS_INFORMATICA">Informática</option><option value="INDUSTRIAL_DEPOSITO">Industrial/Depósito</option><option value="OTROS">Otros</option></select></div></div>
<div class="row cols-3"><div><label>Curso</label><input id="f-curso"></div><div><label>Buscar</label><input id="f-q" placeholder="Nombre/Registro"></div><div class="actions" style="align-self:end"><button class="btn" id="btn-refresh">Actualizar</button><button class="btn" id="btn-export-csv">CSV</button><button class="btn" id="btn-export-xls">XLS</button><button class="btn" id="btn-export-json">JSON</button><button class="btn" id="btn-export-zip">ZIP constancias</button></div></div>
<div class="row"><table id="tbl"><thead><tr><th>Registro</th><th>Tipo</th><th>Estado</th><th>Curso</th><th>Titular</th><th>CUIT</th><th>Rubro</th><th>Fecha</th><th>Vence</th><th>Adjuntos</th><th>Acciones</th></tr></thead><tbody></tbody></table></div>
</div></div></section><footer>© <span id="y"></span> · San Antonio de Padua — Derechos reservados.</footer>
<script>document.getElementById('y').textContent=new Date().getFullYear();</script>
<dialog id="dlg"><div class="modal-head"><strong>Constancia — Simulación</strong><button class="btn" onclick="document.getElementById('dlg').close()">Cerrar</button></div><div class="modal-body"><div class="constancia" id="constancia"></div><div class="actions" style="justify-content:space-between"><span class="helper">Imprimir / Guardar como PDF</span><div><button class="btn" id="btn-print">Imprimir / PDF</button><button class="btn" id="btn-download">Descargar HTML</button></div></div></div></dialog>
<script type="module">
import { $, lsGet, K_PF_MONO, K_PF_RI, loadSettings, MiniQR, buildZip, fetchRemoteRows } from "../assets/utils.js";
let current=null; const tbody=document.querySelector('#tbl tbody'); let remoteRows=[];
function rowsLocal(){const A=lsGet(K_PF_MONO).map(r=>({...r,tipo:'PF-MONO'}));const B=lsGet(K_PF_RI).map(r=>({...r,tipo:'PF-RI'}));return [...A,...B]}
function mergeRows(){const m=new Map(); for(const r of rowsLocal()) m.set(r.registro,r); for(const rr of remoteRows.map(x=>x.data || x)) if(rr && rr.registro) m.set(rr.registro,{...(m.get(rr.registro)||{}),...rr}); return Array.from(m.values()); }
function apply(rows){const t=$('#f-tipo').value, est=$('#f-estado').value, rub=$('#f-rubro').value, c=$('#f-curso').value.trim().toUpperCase(), q=$('#f-q').value.trim().toUpperCase();return rows.filter(r=>((!t||r.tipo===t)&&(!rub||r.rubro===rub)&&(!c||String(r.meta?.curso||'').toUpperCase().includes(c))&&(!q||[r.registro,r.cuit,r.nombre].filter(Boolean).join(' ').toUpperCase().includes(q))&&(!est||(String(r.completo?1:0)===est))))}
function render(){tbody.innerHTML='';apply(mergeRows()).forEach(r=>{const tr=document.createElement('tr');const f=d=>new Date(d).toLocaleDateString('es-AR');const adj=(r.files&&r.files.length)?(r.files.length+' 📎'):'—';tr.innerHTML=`<td>${r.registro||'—'}</td><td>${r.tipo||'—'}</td><td>${r.completo?'✅':'⚠️'}</td><td>${r.meta?.curso||''}</td><td>${r.nombre||''}</td><td>${r.cuit||''}</td><td>${r.rubro||''}</td><td>${r.fecha?f(r.fecha):'—'}</td><td>${r.vencimiento?f(r.vencimiento):'—'}</td><td>${adj}</td><td><button class="btn" data-act="view" data-reg="${r.registro}">Ver / Imprimir</button> <button class="btn" data-act="download" data-reg="${r.registro}">Descargar</button></td>`;tbody.appendChild(tr);})}
function constanciaHTML(r){const s=loadSettings();const sup=+(r.sup||0);const isFood=r.rubro==='ALIMENTOS_GASTRONOMIA';const env=(r.rubro==='INDUSTRIAL_DEPOSITO')||sup>80;const adj=(r.files&&r.files.length)?('<h4>Adjuntos remotos</h4><ul>'+r.files.map(x=>`<li><a href="${x.url}" target="_blank" rel="noreferrer">${x.name||'archivo'}</a></li>`).join('')+'</ul>'):'<em>Sin adjuntos remotos</em>';return `<div><h3>Municipalidad de Escobar — Habilitación digital provisoria — Simulación</h3><p><strong>N° de Registro:</strong> ${r.registro}</p><p><strong>Titular:</strong> ${r.nombre} · <strong>CUIT:</strong> ${r.cuit}</p><p><strong>Domicilio comercial:</strong> ${r.dom_com||'—'}</p><p><strong>Rubro:</strong> ${r.rubro||'—'} · <strong>Superficie:</strong> ${r.sup||'—'} m²</p><ul><li><strong>Zonificación:</strong> ${(r.nroZonificacion?'N° '+r.nroZonificacion:'(adjunto)')||'—'}</li><li><strong>Seguridad e Higiene:</strong> ${(r.matafuegosOk&&r.matafuegosFecha&&r.lucesEmergencia&&r.senaleticaSalida)?'OK':'Pendiente'}</li><li><strong>Instalaciones:</strong> ${r.ddjjInstalaciones?'DDJJ':'Apto (adjunto)'}</li><li><strong>Ambiental:</strong> ${env ? (r.categoriaAmbiental?('Cat. '+r.categoriaAmbiental):'Pendiente') : 'No corresponde'}</li><li><strong>Bromatología:</strong> ${isFood ? 'Presentada' : 'No corresponde'}</li><li><strong>Libre Deuda:</strong> Adjunto</li><li><strong>Tasa de Habilitación:</strong> Adjunto</li><li><strong>Cartelería:</strong> ${r.carteleria ? ((r.m2Cartel||0)+' m²'+(r.iluminado?' · iluminado':'')) : 'No'}</li></ul>${adj}<div class='seal'><div class='qr' id='qrbox'>QR</div><div class='meta'><div><strong>Sello:</strong> ${(s.prefijo||'ESCOBAR360')} · ${(s.year||'')} · ${(s.curso||'')} · ${(s.docente||'')} · ${(s.version||'')}</div><div><strong>Tipo:</strong> ${r.tipo} · <strong>Estado:</strong> ${r.completo ? 'Completo ✅' : 'Incompleto ⚠️'}</div></div></div><div class='disclaimer'>Uso pedagógico. No corresponde a un trámite real.</div></div>`;}
function printableHTML(r){const base = `<!DOCTYPE html><html><head><meta charset='utf-8'><title>Constancia ${r.registro}</title><style>body{font-family:Arial,system-ui;background:#fff;color:#111;margin:24px}.constancia{max-width:680px;margin:auto;border:1px solid #ddd;border-radius:12px;padding:18px}.seal{display:flex;gap:12px;align-items:center;margin-top:8px}.qr{width:110px;height:110px;border:1px solid #ddd;display:inline-grid;place-items:center}.meta{font-size:12px;color:#333}.disclaimer{font-size:12px;color:#333;margin-top:10px}ul{margin:8px 0 0 18px}</style></head><body><div class='constancia'>`+constanciaHTML(r)+`</div>`; const scrOpen = '<scr' + 'ipt>'; const scrClose = '</scr' + 'ipt>'; const payload = `var p={r:'${r.registro}',t:'${r.tipo}',c:'${r.cuit}',d:'${r.fecha}'};`; const script = `${scrOpen}(function(){function MiniQR(e){this.el=e}MiniQR.prototype.make=function(t){var c=document.createElement('canvas'),s=128;c.width=c.height=s;var g=c.getContext('2d');g.fillStyle='#fff';g.fillRect(0,0,s,s);g.fillStyle='#000';function f(x,y){g.fillRect(x,y,28,28);g.fillStyle='#fff';g.fillRect(x+6,y+6,16,16);g.fillStyle='#000';g.fillRect(x+10,y+10,8,8)}f(6,6);f(s-34,6);f(6,s-34);var h=0;String(t).split('').forEach(function(ch){h=(h*31+ch.charCodeAt(0))>>>0});for(var y=0;y<40;y++)for(var x=0;x<40;x++)if(((x*1103515245+y*12345+h)>>5)&1)g.fillRect(36+x*2,36+y*2,2,2);this.el.innerHTML='';this.el.appendChild(c)};${payload}new MiniQR(document.getElementById('qrbox')).make(JSON.stringify(p));setTimeout(function(){window.print()},200);})();${scrClose}</body></html>`; return base + script;}
function downloadHTML(r,auto=false){const html=printableHTML(r); const re=new RegExp('<scr'+'ipt>[\\s\\S]*?<\\/scr'+'ipt>','i'); const clean = auto?html:html.replace(re,''); const blob=new Blob([clean],{type:'text/html;charset=utf-8'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`constancia_${r.registro}.html`; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),1500);}
tbody.addEventListener('click',e=>{const btn=e.target.closest('button[data-act]');if(!btn)return;const reg=btn.getAttribute('data-reg');const r=mergeRows().find(x=>x.registro===reg);if(!r)return alert('Registro no encontrado');if(btn.dataset.act==='view'){current=r;document.getElementById('constancia').innerHTML=constanciaHTML(r);new MiniQR(document.getElementById('qrbox')).make(JSON.stringify({r:r.registro,t:r.tipo,c:r.cuit,d:r.fecha}));document.getElementById('dlg').showModal();}if(btn.dataset.act==='download'){downloadHTML(r,false)}});
document.getElementById('btn-print').addEventListener('click',()=>{if(!current)return;const w=window.open('about:blank','_blank');w.document.write(printableHTML(current));w.document.close();});
function exportCSV(){const data=mergeRows();const headers=['registro','tipo','estado','curso','titular','cuit','rubro','fecha','vence'];const csv=[headers.join(',')].concat(data.map(r=>[r.registro,r.tipo,(r.completo?'completo':'incompleto'),r.meta?.curso||'',(r.nombre||'').replaceAll(',',' '),r.cuit,r.rubro||'',r.fecha||'',r.vencimiento||''].join(','))).join('\n');const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='escobar360_empleados.csv';document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(url),1500)}
function exportXLS(){const data=mergeRows();const esc=x=>String(x??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');const html=`<!DOCTYPE html><html><head><meta charset='utf-8'></head><body><table border='1'>`+`<tr><th>Registro</th><th>Tipo</th><th>Estado</th><th>Curso</th><th>Titular</th><th>CUIT</th><th>Rubro</th><th>Fecha</th><th>Vence</th></tr>`+data.map(r=>`<tr><td>${esc(r.registro)}</td><td>${esc(r.tipo)}</td><td>${esc(r.completo?'completo':'incompleto')}</td><td>${esc(r.meta?.curso||'')}</td><td>${esc(r.nombre||'')}</td><td>${esc(r.cuit)}</td><td>${esc(r.rubro||'')}</td><td>${esc(r.fecha||'')}</td><td>${esc(r.vencimiento||'')}</td></tr>`).join('')+`</table></body></html>`;const blob=new Blob([html],{type:'application/vnd.ms-excel'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='escobar360_empleados.xls';document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(url),1500)}
function exportJSON(){const data=mergeRows();const blob=new Blob([JSON.stringify({registros:data},null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='escobar360_empleados.json';document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(url),1500)}
async function exportZIP(){const enc=new TextEncoder();const data=apply(mergeRows());const files=data.map(r=>({name:`constancia_${r.registro}.html`,data:enc.encode(printableHTML(r).replace(new RegExp('<scr'+'ipt>[\\s\\S]*?<\\/scr'+'ipt>','i'),''))}));const zipBytes=buildZip(files);const blob=new Blob([zipBytes],{type:'application/zip'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='escobar360_constancias.zip';document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(url),1500)}
async function syncRemote(){ try{remoteRows = await fetchRemoteRows();}catch(e){remoteRows=[];} render(); }
document.getElementById('btn-export-csv').addEventListener('click',exportCSV);document.getElementById('btn-export-xls').addEventListener('click',exportXLS);document.getElementById('btn-export-json').addEventListener('click',exportJSON);document.getElementById('btn-export-zip').addEventListener('click',exportZIP);
document.getElementById('btn-login').addEventListener('click',()=>{const u=document.getElementById('login-user').value.trim().toUpperCase();const p=document.getElementById('login-pass').value;if(u==='MUNI'&&p==='MUNIISAP123'){document.getElementById('panel-sec').hidden=false;syncRemote();}else alert('Usuario/clave incorrectos (tips: MUNI / MUNIISAP123)')});
document.getElementById('btn-refresh').addEventListener('click',syncRemote);document.getElementById('f-tipo').addEventListener('change',render);document.getElementById('f-estado').addEventListener('change',render);document.getElementById('f-rubro').addEventListener('change',render);document.getElementById('f-curso').addEventListener('input',render);document.getElementById('f-q').addEventListener('input',render);
</script></body></html>